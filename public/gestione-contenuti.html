<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#2400C1',
              secondary: '#8E008C',
              accent: '#00BFFF',
              textDark: '#1C1C1E',
              backgroundLight: '#F4F4F8',
              white: '#FFFFFF',
              danger: '#DC2626',
            },
            backgroundImage: { 'hero': "linear-gradient(135deg, #2400C1, #8E008C)" },
            fontFamily: { sans: ['Segoe UI', 'Roboto', 'sans-serif'] },
          }
        }
      }
    </script>
    <title>Gestione Contenuti | MyApp</title>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#2400C1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass-effect { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.18); }
        .nav-item:hover { transform: translateY(-3px); transition: all 0.3s ease; }
        .gradient-text { background: linear-gradient(135deg, #2400C1, #8E008C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); transition: all 0.4s ease; }
        .tab-button.active { background-color: #2400C1; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-backgroundLight font-sans text-textDark">

    <header class="glass-effect fixed top-0 left-0 right-0 z-20">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
             <h1 class="text-2xl font-bold gradient-text">Gestione Contenuti</h1>
            <a href="/public/logout.html" class="text-danger font-semibold">Logout</a>
        </div>
    </header>

    <main class="container mx-auto p-4 pt-24 pb-28 space-y-6">
        <!-- Feedback Messages -->
        <div id="feedback" class="hidden"></div>

        <!-- Tab Navigation -->
        <div class="flex bg-white rounded-lg p-1 shadow-md">
            <button onclick="showTab('notizie')" class="tab-button flex-1 py-2 px-4 rounded-md font-semibold text-gray-700 hover:bg-gray-100 active" id="tab-notizie">
                üì¢ Gestione Notizie
            </button>
            <button onclick="showTab('convenzioni')" class="tab-button flex-1 py-2 px-4 rounded-md font-semibold text-gray-700 hover:bg-gray-100" id="tab-convenzioni">
                ü§ù Gestione Convenzioni
            </button>
        </div>

        <!-- GESTIONE NOTIZIE -->
        <div id="content-notizie" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form Aggiungi Notizia -->
                <div class="card-hover bg-white p-6 rounded-3xl shadow-lg border">
                    <h3 class="font-bold text-xl gradient-text mb-4">Aggiungi Nuova Notizia</h3>
                    <form id="addNotiziaForm" class="space-y-4">
                        <div>
                            <label for="notizia-titolo" class="block text-sm font-medium text-gray-700">Titolo</label>
                            <input type="text" id="notizia-titolo" name="titolo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="notizia-contenuto" class="block text-sm font-medium text-gray-700">Contenuto</label>
                            <textarea id="notizia-contenuto" name="contenuto" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"></textarea>
                        </div>
                        <div>
                            <label for="notizia-priorita" class="block text-sm font-medium text-gray-700">Priorit√†</label>
                            <select id="notizia-priorita" name="priorita" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                <option value="normale">Normale</option>
                                <option value="importante">Importante</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                            Pubblica Notizia
                        </button>
                    </form>
                </div>

                <!-- Lista Notizie Esistenti -->
                <div class="card-hover bg-white p-6 rounded-3xl shadow-lg border">
                    <h3 class="font-bold text-xl gradient-text mb-4">Notizie Pubblicate</h3>
                    <div id="notizie-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Caricamento notizie...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIONE CONVENZIONI -->
        <div id="content-convenzioni" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form Aggiungi Convenzione -->
                <div class="card-hover bg-white p-6 rounded-3xl shadow-lg border">
                    <h3 class="font-bold text-xl gradient-text mb-4">Aggiungi Nuova Convenzione</h3>
                    <form id="addConvenzioneForm" class="space-y-4">
                        <div>
                            <label for="convenzione-nome" class="block text-sm font-medium text-gray-700">Nome Partner</label>
                            <input type="text" id="convenzione-nome" name="nome_partner" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="convenzione-descrizione" class="block text-sm font-medium text-gray-700">Descrizione</label>
                            <textarea id="convenzione-descrizione" name="descrizione" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"></textarea>
                        </div>
                        <div>
                            <label for="convenzione-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                            <select id="convenzione-categoria" name="categoria" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                <option value="assicurazioni">Assicurazioni</option>
                                <option value="automotive">Automotive</option>
                                <option value="tecnologia">Tecnologia</option>
                                <option value="viaggi">Viaggi</option>
                                <option value="wellness">Wellness</option>
                                <option value="shopping">Shopping</option>
                                <option value="servizi">Servizi</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div>
                            <label for="convenzione-sconto" class="block text-sm font-medium text-gray-700">Sconto (%)</label>
                            <input type="number" id="convenzione-sconto" name="sconto_percentuale" min="0" max="100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="convenzione-link" class="block text-sm font-medium text-gray-700">Link Esterno</label>
                            <input type="url" id="convenzione-link" name="link_esterno" placeholder="https://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="convenzione-logo" class="block text-sm font-medium text-gray-700">URL Logo</label>
                            <input type="url" id="convenzione-logo" name="logo_url" placeholder="https://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        </div>
                        <button type="submit" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                            Aggiungi Convenzione
                        </button>
                    </form>
                </div>

                <!-- Lista Convenzioni Esistenti -->
                <div class="card-hover bg-white p-6 rounded-3xl shadow-lg border">
                    <h3 class="font-bold text-xl gradient-text mb-4">Convenzioni Attive</h3>
                    <div id="convenzioni-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Caricamento convenzioni...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Navigation Bar con Home -->
    <nav class="fixed bottom-0 left-0 right-0 glass-effect z-20">
        <div class="container mx-auto flex justify-around py-3">
            <a href="home.html" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary p-3">
                <span class="text-3xl">üè†</span><span class="text-xs mt-1">Home</span>
            </a>
            <a href="tessera.html" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary p-3">
                <span class="text-3xl">üí≥</span><span class="text-xs mt-1">Tessera</span>
            </a>
            <a href="gestione-contenuti.html" class="nav-item flex flex-col items-center text-primary p-3">
                <span class="text-3xl">üìù</span><span class="text-xs font-bold mt-1">Gestione</span>
            </a>
            <a href="profilo.html" class="nav-item flex flex-col items-center text-gray-600 hover:text-primary p-3">
                <span class="text-3xl">üë§</span><span class="text-xs mt-1">Profilo</span>
            </a>
        </div>
    </nav>

    <script>
        // ========================================================================
        //                    GESTIONE CONTENUTI DIRIGENTI
        // ========================================================================

        const SUPABASE_URL = "https://lycrgzptkdkksukcwrld.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5Y3JnenB0a2Rra3N1a2N3cmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODQyMzAsImV4cCI6MjA2ODM2MDIzMH0.ZJGOXAMC3hKKrnwXHKEa2_Eh7ZpOKeLYvYlYneBiEfk";
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.error("Errore durante l'inizializzazione di Supabase:", error);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Feedback Management
        function showFeedback(message, type = 'success') {
            const feedback = document.getElementById('feedback');
            const colors = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700'
            };
            
            feedback.innerHTML = `
                <div class="${colors[type]} px-4 py-3 rounded border">
                    <p>${message}</p>
                </div>
            `;
            feedback.classList.remove('hidden');
            
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 5000);
        }

        // ===== GESTIONE NOTIZIE =====
        
        async function loadNotizie() {
            try {
                const { data: notizie, error } = await supabase
                    .from('notizie')
                    .select('*')
                    .order('data_pubblicazione', { ascending: false });
                
                if (error) throw error;
                
                const notizieList = document.getElementById('notizie-list');
                if (notizie && notizie.length > 0) {
                    notizieList.innerHTML = notizie.map(notizia => `
                        <div class="border rounded-lg p-3 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">${notizia.titolo}</h4>
                                    <p class="text-sm text-gray-600 mt-1">${notizia.contenuto}</p>
                                    <div class="flex items-center mt-2 space-x-2">
                                        <span class="text-xs px-2 py-1 rounded-full ${getPriorityColor(notizia.priorita)}">${notizia.priorita}</span>
                                        <span class="text-xs text-gray-500">${new Date(notizia.data_pubblicazione).toLocaleDateString('it-IT')}</span>
                                    </div>
                                </div>
                                <button onclick="deleteNotizia('${notizia.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                    <span class="text-lg">üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    notizieList.innerHTML = '<p class="text-gray-500">Nessuna notizia pubblicata.</p>';
                }
            } catch (error) {
                console.error('Errore nel caricare le notizie:', error);
                showFeedback('Errore nel caricamento delle notizie', 'error');
            }
        }

        function getPriorityColor(priorita) {
            const colors = {
                normale: 'bg-blue-100 text-blue-800',
                importante: 'bg-yellow-100 text-yellow-800',
                urgente: 'bg-red-100 text-red-800'
            };
            return colors[priorita] || colors.normale;
        }

        async function addNotizia(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const { error } = await supabase
                    .from('notizie')
                    .insert([{
                        titolo: formData.get('titolo'),
                        contenuto: formData.get('contenuto'),
                        priorita: formData.get('priorita'),
                        data_pubblicazione: new Date().toISOString(),
                        pubblicata: true
                    }]);
                
                if (error) throw error;
                
                showFeedback('Notizia pubblicata con successo!');
                event.target.reset();
                loadNotizie();
            } catch (error) {
                console.error('Errore nell\'aggiungere la notizia:', error);
                showFeedback('Errore nella pubblicazione della notizia', 'error');
            }
        }

        async function deleteNotizia(id) {
            if (!confirm('Sei sicuro di voler eliminare questa notizia?')) return;
            
            try {
                const { error } = await supabase
                    .from('notizie')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showFeedback('Notizia eliminata con successo!');
                loadNotizie();
            } catch (error) {
                console.error('Errore nell\'eliminare la notizia:', error);
                showFeedback('Errore nell\'eliminazione della notizia', 'error');
            }
        }

        // ===== GESTIONE CONVENZIONI =====
        
        async function loadConvenzioni() {
            try {
                const { data: convenzioni, error } = await supabase
                    .from('convenzioni')
                    .select('*')
                    .order('nome_partner');
                
                if (error) throw error;
                
                const convenzioniList = document.getElementById('convenzioni-list');
                if (convenzioni && convenzioni.length > 0) {
                    convenzioniList.innerHTML = convenzioni.map(convenzione => `
                        <div class="border rounded-lg p-3 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center space-x-3 flex-1">
                                    ${convenzione.logo_url ? 
                                        `<img src="${convenzione.logo_url}" alt="${convenzione.nome_partner}" class="w-12 h-12 object-contain rounded">` :
                                        `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><span class="text-2xl">üè™</span></div>`
                                    }
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900">${convenzione.nome_partner}</h4>
                                        <p class="text-sm text-gray-600">${convenzione.descrizione || ''}</p>
                                        <div class="flex items-center mt-1 space-x-2">
                                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${convenzione.categoria}</span>
                                            ${convenzione.sconto_percentuale ? `<span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">${convenzione.sconto_percentuale}% sconto</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="deleteConvenzione('${convenzione.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                    <span class="text-lg">üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    convenzioniList.innerHTML = '<p class="text-gray-500">Nessuna convenzione attiva.</p>';
                }
            } catch (error) {
                console.error('Errore nel caricare le convenzioni:', error);
                showFeedback('Errore nel caricamento delle convenzioni', 'error');
            }
        }

        async function addConvenzione(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const { error } = await supabase
                    .from('convenzioni')
                    .insert([{
                        nome_partner: formData.get('nome_partner'),
                        descrizione: formData.get('descrizione'),
                        categoria: formData.get('categoria'),
                        sconto_percentuale: formData.get('sconto_percentuale') ? parseInt(formData.get('sconto_percentuale')) : null,
                        link_esterno: formData.get('link_esterno'),
                        logo_url: formData.get('logo_url'),
                        attiva: true,
                        data_inizio: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                showFeedback('Convenzione aggiunta con successo!');
                event.target.reset();
                loadConvenzioni();
            } catch (error) {
                console.error('Errore nell\'aggiungere la convenzione:', error);
                showFeedback('Errore nell\'aggiunta della convenzione', 'error');
            }
        }

        async function deleteConvenzione(id) {
            if (!confirm('Sei sicuro di voler eliminare questa convenzione?')) return;
            
            try {
                const { error } = await supabase
                    .from('convenzioni')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showFeedback('Convenzione eliminata con successo!');
                loadConvenzioni();
            } catch (error) {
                console.error('Errore nell\'eliminare la convenzione:', error);
                showFeedback('Errore nell\'eliminazione della convenzione', 'error');
            }
        }

        // ===== VERIFICA AUTORIZZAZIONI =====
        
        async function checkDirigentePermissions() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = '/public/login.html';
                    return;
                }

                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('ruoli')
                    .eq('id', session.user.id)
                    .single();

                if (error) throw error;

                const roles = profile?.ruoli || [];
                if (!roles.includes('DIRIGENTE') && !roles.includes('ADMIN')) {
                    window.location.href = '/app/home.html';
                    return;
                }
            } catch (error) {
                console.error('Errore nel verificare i permessi:', error);
                window.location.href = '/app/home.html';
            }
        }

        // ===== INIZIALIZZAZIONE =====
        
        document.addEventListener('DOMContentLoaded', async () => {
            await checkDirigentePermissions();
            
            // Event Listeners
            document.getElementById('addNotiziaForm').addEventListener('submit', addNotizia);
            document.getElementById('addConvenzioneForm').addEventListener('submit', addConvenzione);
            
            // Load initial data
            loadNotizie();
            loadConvenzioni();
        });
    </script>
<nav class="footer-nav">
    <div class="footer-nav-container">
        <a href="home.html" class="footer-nav-item">
            <span class="footer-nav-icon">üè†</span>
            <span class="footer-nav-label">Home</span>
        </a>
        <a href="tessera.html" class="footer-nav-item">
            <span class="footer-nav-icon">üí≥</span>
            <span class="footer-nav-label">Tessera</span>
        </a>
        <a href="servizi.html" class="footer-nav-item">
            <span class="footer-nav-icon">üõ†Ô∏è</span>
            <span class="footer-nav-label">Servizi</span>
        </a>
        <a href="profilo.html" class="footer-nav-item">
            <span class="footer-nav-icon">üë§</span>
            <span class="footer-nav-label">Profilo</span>
        </a>
    </div>
</nav>
    </nav>
</body>
</html>